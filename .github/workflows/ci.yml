# GitHub Actions - CI/CD Pipeline
name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: bot-mercadolivre
  REGISTRY: ghcr.io

jobs:
  # Job 1: Testes e Linting
  test:
    name: Tests & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest
    
    - name: ðŸ§¹ Lint com flake8
      run: |
        # Para erros de sintaxe ou nomes nÃ£o definidos
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Avisos gerais (nÃ£o falha)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: ðŸ§ª Verificar imports
      run: |
        python -c "
        import sys
        errors = []
        
        try:
            from utils.support import wait_for_element
            print('âœ“ utils.support OK')
        except Exception as e:
            errors.append(f'utils.support: {e}')
        
        try:
            from utils.environment import create_driver
            print('âœ“ utils.environment OK')
        except Exception as e:
            errors.append(f'utils.environment: {e}')
        
        if errors:
            print('Erros encontrados:')
            for err in errors:
                print(f'  - {err}')
            sys.exit(1)
        "
    
    - name: âœ… Resultado dos testes
      run: echo "Testes concluÃ­dos com sucesso"

  # Job 2: Build Docker
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ“ Criar account.txt temporÃ¡rio
      run: |
        echo "login = test@example.com" > account.txt
        echo "password = test123" >> account.txt
    
    - name: ðŸ”¨ Build imagem Docker
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ${{ env.IMAGE_NAME }}:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ðŸ§ª Testar imagem
      run: |
        docker run --rm \
          -e PYTHONUNBUFFERED=1 \
          -e IN_DOCKER=true \
          ${{ env.IMAGE_NAME }}:test \
          python -c "
        import sys
        print('Python version:', sys.version)
        
        from utils.environment import is_running_in_docker, get_chromedriver_path
        print('Running in Docker:', is_running_in_docker())
        print('ChromeDriver path:', get_chromedriver_path())
        print('âœ“ Container test passed')
        "
    
    - name: âœ… Build completado
      run: echo "Docker image built successfully"

  # Job 3: Build Podman (opcional)
  build-podman:
    name: Build Podman Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Instalar Podman
      run: |
        sudo apt-get update
        sudo apt-get -y install podman
    
    - name: ðŸ“ Criar account.txt temporÃ¡rio
      run: |
        echo "login = test@example.com" > account.txt
        echo "password = test123" >> account.txt
    
    - name: ðŸ”¨ Build imagem Podman
      run: |
        podman build -t ${{ env.IMAGE_NAME }}:test .
    
    - name: ðŸ§ª Testar imagem
      run: |
        podman run --rm \
          -e PYTHONUNBUFFERED=1 \
          -e IN_DOCKER=true \
          ${{ env.IMAGE_NAME }}:test \
          python -c "print('âœ“ Podman container test passed')"
    
    - name: âœ… Build completado
      run: echo "Podman image built successfully"

  # Job 4: Security Scan (opcional)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ðŸ”’ Verificar credenciais vazadas
      run: |
        # Verifica se account.txt estÃ¡ no .gitignore
        if grep -q "account.txt" .gitignore; then
          echo "âœ“ account.txt estÃ¡ no .gitignore"
        else
          echo "âš ï¸  AVISO: account.txt nÃ£o estÃ¡ no .gitignore"
        fi
        
        # Verifica se hÃ¡ credenciais hardcoded
        if grep -rn "password.*=" --include="*.py" . | grep -v "password = " | grep -v "# password"; then
          echo "âš ï¸  PossÃ­veis credenciais encontradas no cÃ³digo"
          exit 1
        fi
        
        echo "âœ“ Nenhuma credencial hardcoded encontrada"
    
    - name: ðŸ“¦ Scan de dependÃªncias
      run: |
        pip install safety
        safety check --json || echo "âš ï¸  Alguns avisos de seguranÃ§a encontrados"
      continue-on-error: true

  # Job 5: DocumentaÃ§Ã£o
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“š Verificar documentaÃ§Ã£o
      run: |
        required_files=(
          "README.md"
          "MANUAL_USO.md"
          "PODMAN_GUIDE.md"
          "Dockerfile"
          "docker-compose.yml"
          "Makefile"
        )
        
        missing=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing+=("$file")
          fi
        done
        
        if [ ${#missing[@]} -eq 0 ]; then
          echo "âœ“ Todos os arquivos de documentaÃ§Ã£o presentes"
        else
          echo "âš ï¸  Arquivos faltando: ${missing[*]}"
          exit 1
        fi
    
    - name: âœ… DocumentaÃ§Ã£o OK
      run: echo "Documentation check passed"

  # Job 6: Release (apenas em tags)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, build-docker, security]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ“ Generate Release Notes
      run: |
        cat > release_notes.md << EOF
        # Bot Mercado Livre - $(git describe --tags)
        
        ## ðŸš€ Melhorias
        - Build testado automaticamente
        - Container Docker/Podman validado
        - Testes de seguranÃ§a passados
        
        ## ðŸ“¦ Como usar
        
        \`\`\`bash
        # Clone o repositÃ³rio
        git clone https://github.com/${{ github.repository }}.git
        
        # Configure credenciais
        cp account.txt.example account.txt
        # Edite account.txt
        
        # Execute com Podman/Docker
        ./run-podman.sh
        
        # Ou localmente
        pip install -r requirements.txt
        python run_bot.py
        \`\`\`
        
        ## ðŸ“š DocumentaÃ§Ã£o
        - [Manual de Uso](MANUAL_USO.md)
        - [Guia Podman/Docker](PODMAN_GUIDE.md)
        EOF
    
    - name: ðŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
